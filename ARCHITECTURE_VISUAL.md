# Multi-Tenant CMS - Visual Architecture

## The Request Flow Diagram

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                                                             â”‚
â”‚  User Types: cool-barber.com into browser                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Browser sends HTTP request
                      â”‚ Host: cool-barber.com
                      â”‚ Path: /services
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      MIDDLEWARE (THE MAGIC)                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  if (hostname includes 'cool-barber.com') {                â”‚
â”‚    rewrite path to: /site/cool-barber.com/services         â”‚
â”‚  }                                                          â”‚
â”‚                                                             â”‚
â”‚  Result:                                                    â”‚
â”‚  âœ… Browser URL unchanged: cool-barber.com/services        â”‚
â”‚  âœ… Server serves from: /site/cool-barber.com/services    â”‚
â”‚  âœ… User sees no redirect                                  â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Rewritten path reaches Next.js router
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               NEXT.JS ROUTER & LAYOUT                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Route: /site/[domain]/layout.tsx                          â”‚
â”‚                                                             â”‚
â”‚  params = { domain: 'cool-barber.com' }                    â”‚
â”‚                                                             â”‚
â”‚  â”œâ”€ Call: getSiteData('cool-barber.com')                   â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”‚  â–¼                                                       â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”‚
â”‚  â”‚  â”‚   MOCK DATABASE (lib/data.ts) â”‚                     â”‚
â”‚  â”‚  â”‚   (Soon: Supabase)            â”‚                     â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
â”‚  â”‚         â”‚                                               â”‚
â”‚  â”‚         â–¼ Finds site record                             â”‚
â”‚  â”‚  {                                                      â”‚
â”‚  â”‚    domain: 'cool-barber.com',                           â”‚
â”‚  â”‚    siteName: "Cool Barber's",                           â”‚
â”‚  â”‚    template: 'barber',                                  â”‚
â”‚  â”‚    theme: {                                             â”‚
â”‚  â”‚      primaryColor: '#1e40af',                           â”‚
â”‚  â”‚      accentColor: '#60a5fa',                            â”‚
â”‚  â”‚      backgroundColor: '#0f172a'                         â”‚
â”‚  â”‚    },                                                   â”‚
â”‚  â”‚    content: { pages: {...} }                            â”‚
â”‚  â”‚  }                                                      â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€ Return data to Layout                                  â”‚
â”‚                                                             â”‚
â”‚  Layout renders with dynamic theme:                        â”‚
â”‚  <nav style={{ color: theme.primaryColor }} />             â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Layout passes params to page
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚               NEXT.JS PAGE RENDERER                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Route: /site/[domain]/page.tsx                            â”‚
â”‚                                                             â”‚
â”‚  params = { domain: 'cool-barber.com' }                    â”‚
â”‚                                                             â”‚
â”‚  â”œâ”€ Call: getPageContent('cool-barber.com', '/services') â”‚
â”‚  â”‚  â”œâ”€ Gets sections array                                 â”‚
â”‚  â”‚  â””â”€ Maps through sections                               â”‚
â”‚  â”‚                                                         â”‚
â”‚  â”œâ”€ For each section:                                      â”‚
â”‚  â”‚  â”œâ”€ type: 'hero'      â†’ renderHero(section, theme)     â”‚
â”‚  â”‚  â”œâ”€ type: 'features'  â†’ renderFeatures(section, theme) â”‚
â”‚  â”‚  â””â”€ type: 'contact'   â†’ renderContact(section, theme)  â”‚
â”‚  â”‚                                                         â”‚
â”‚  â””â”€ Return complete React JSX                              â”‚
â”‚                                                             â”‚
â”‚  Example render:                                            â”‚
â”‚  <h1 style={{color: '#1e40af'}}>Cool Barber's</h1>         â”‚
â”‚  <p style={{color: '#60a5fa'}}>Premium haircuts...</p>     â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ React components â†’ HTML
                      â”‚ Server-side rendering (SSR)
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                   RESPONSE TO BROWSER                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  HTTP 200 OK                                                â”‚
â”‚  Content-Type: text/html                                    â”‚
â”‚                                                             â”‚
â”‚  <html>                                                     â”‚
â”‚    <head>                                                   â”‚
â”‚      <title>Cool Barber's</title>                           â”‚
â”‚    </head>                                                  â”‚
â”‚    <body style="background: #0f172a">                       â”‚
â”‚      <h1 style="color: #1e40af">Cool Barber's</h1>         â”‚
â”‚      <p style="color: #60a5fa">Premium haircuts...</p>     â”‚
â”‚      <!-- ... complete HTML page ... -->                   â”‚
â”‚    </body>                                                  â”‚
â”‚  </html>                                                    â”‚
â”‚                                                             â”‚
â”‚  âœ… Fully rendered HTML sent to browser                    â”‚
â”‚  âœ… Browser renders instantly                              â”‚
â”‚  âœ… SEO-friendly (crawlers see full HTML)                  â”‚
â”‚  âœ… Fast (no JavaScript waterfall)                         â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                      â”‚
                      â”‚ Browser displays page
                      â”‚
                      â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    BROWSER DISPLAY                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Address Bar: cool-barber.com/services                     â”‚
â”‚  (URL never changed from original request!)                â”‚
â”‚                                                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚   Cool Barber's                      â”‚                  â”‚
â”‚  â”‚   Premium haircuts                   â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â”‚   Services:                          â”‚                  â”‚
â”‚  â”‚   â€¢ Haircuts                         â”‚  â† Blue theme    â”‚
â”‚  â”‚   â€¢ Beard Trim                       â”‚     (#1e40af)    â”‚
â”‚  â”‚   â€¢ Styling                          â”‚                  â”‚
â”‚  â”‚                                      â”‚                  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                  â”‚
â”‚                                                             â”‚
â”‚  User sees: Perfect barber shop website                    â”‚
â”‚  User doesn't know: It's served from /site/cool-barber.com â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Side-by-Side: Middleware Rewrite vs Redirect

### âŒ Old Way: HTTP Redirect (SLOW)
```
Browser: GET /services
         Host: cool-barber.com
                â”‚
                â”œâ”€ Server: 302 redirect to localhost:3000/site/cool-barber
                â”‚
                â”œâ”€ Browser sees: localhost:3000/site/cool-barber
                â”‚               (ugly URL exposed!)
                â”‚
                â”œâ”€ Browser makes NEW request
                â”‚
                â””â”€ Server responds with page
                
Time: Request 1 + Redirect latency + Request 2 = 600ms+ â±ï¸
URL: Exposed internal path visible to user âŒ
```

### âœ… New Way: Middleware Rewrite (FAST)
```
Browser: GET /services
         Host: cool-barber.com
                â”‚
                â”œâ”€ Server middleware: Rewrite to /site/cool-barber internally
                â”‚  (happens on server, invisible to browser)
                â”‚
                â”œâ”€ Browser still sees: cool-barber.com/services
                â”‚                     (original URL preserved!)
                â”‚
                â””â”€ Server responds with page
                
Time: Request 1 + Internal rewrite (0ms) = 300-400ms â±ï¸âœ¨
URL: Stays clean and professional âœ…
```

---

## Database Schema (Simplified View)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    DATABASE (PostgreSQL)                     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  SITES TABLE                                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ id  â”‚ domain              â”‚ site_name       â”‚ template   â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 1   â”‚ cool-barber.com     â”‚ Cool Barber's   â”‚ barber     â”‚â”‚
â”‚  â”‚ 2   â”‚ demo-pizza.com      â”‚ Demo Pizza Co   â”‚ restaurant â”‚â”‚
â”‚  â”‚ 3   â”‚ photo-studio.com    â”‚ Studio Photos   â”‚ portfolio  â”‚â”‚
â”‚  â”‚ 4   â”‚ plumbing-co.com     â”‚ Plumbing Co     â”‚ service    â”‚â”‚
â”‚  â”‚ ... â”‚ ...                 â”‚ ...             â”‚ ...        â”‚â”‚
â”‚  â”‚1000 â”‚ customer-1000.com   â”‚ Customer 1000   â”‚ restaurant â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  THEME TABLE (or JSONB field in SITES)                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ site_id â”‚ primary_color â”‚ accent_color â”‚ bg_color      â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 1       â”‚ #1e40af       â”‚ #60a5fa      â”‚ #0f172a       â”‚â”‚
â”‚  â”‚ 2       â”‚ #dc2626       â”‚ #f87171      â”‚ #1f2937       â”‚â”‚
â”‚  â”‚ 3       â”‚ #059669       â”‚ #6ee7b7      â”‚ #064e3b       â”‚â”‚
â”‚  â”‚ ...     â”‚ ...           â”‚ ...          â”‚ ...           â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â”‚  CONTENT TABLE (or JSONB field in SITES)                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”â”‚
â”‚  â”‚ site_id â”‚ page_path â”‚ sections (JSON array)            â”‚â”‚
â”‚  â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤â”‚
â”‚  â”‚ 1       â”‚ /         â”‚ [{type: 'hero',...}, {...}]      â”‚â”‚
â”‚  â”‚ 1       â”‚ /about    â”‚ [{type: 'about',...}, {...}]     â”‚â”‚
â”‚  â”‚ 1       â”‚ /contact  â”‚ [{type: 'contact',...}, {...}]   â”‚â”‚
â”‚  â”‚ 2       â”‚ /         â”‚ [{type: 'hero',...}, {...}]      â”‚â”‚
â”‚  â”‚ ...     â”‚ ...       â”‚ ...                               â”‚â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## Deployment Architecture

### Traditional (Per-Customer)
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Vercel (Cloud)                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                             â”‚
â”‚  Customer 1: Next.js Instance #1 â”€â†’ Database #1             â”‚
â”‚  cool-barber.com â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚  Customer 2: Next.js Instance #2 â”€â†’ Database #2             â”‚
â”‚  demo-pizza.com â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚  Customer 3: Next.js Instance #3 â”€â†’ Database #3             â”‚
â”‚  photo-studio.com â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                                                             â”‚
â”‚  ...repeat for each customer...                             â”‚
â”‚  ğŸ’° Cost: $50-100 per customer per month                   â”‚
â”‚                                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Our Multi-Tenant
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                      Vercel (Cloud)                           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚          Single Next.js Instance                      â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  Middleware (routes by domain)                        â”‚  â”‚
â”‚  â”‚      â”‚                                                â”‚  â”‚
â”‚  â”‚      â”œâ”€ cool-barber.com â”€â”€â”                          â”‚  â”‚
â”‚  â”‚      â”œâ”€ demo-pizza.com â”€â”€â”€â”¼â”€ /site/[domain]         â”‚  â”‚
â”‚  â”‚      â””â”€ photo-studio.com â”€â”˜                          â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  (All 1000+ sites served from same code)             â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                           â”‚                                  â”‚
â”‚                           â–¼                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚           Single Shared Database                      â”‚  â”‚
â”‚  â”‚              (Supabase/PostgreSQL)                    â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â”‚  Contains data for ALL 1000+ sites                    â”‚  â”‚
â”‚  â”‚  Cost: $25/month base (not per customer!)             â”‚  â”‚
â”‚  â”‚                                                       â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚                                                              â”‚
â”‚  ğŸ’° Cost: $45/month total (not per customer!)               â”‚
â”‚  ğŸ“ˆ Scales to 1 million sites without code changes         â”‚
â”‚                                                              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## The Middleware Decision Tree

```
Request arrives: cool-barber.com/about
         â”‚
         â–¼
    Read Host header: "cool-barber.com"
         â”‚
         â”œâ”€ Is it "app.yourdomain.com"?
         â”‚  â”œâ”€ YES â†’ Serve dashboard normally
         â”‚  â”‚  â””â”€ User sees: /dashboard, /templates, etc
         â”‚  â”‚
         â”‚  â””â”€ NO â†’ It's a client site
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Rewrite path to: /site/cool-barber.com/about
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Next.js routes to: app/(site)/[domain]/page.tsx
         â”‚  with params: { domain: "cool-barber.com" }
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Layout calls: getSiteData("cool-barber.com")
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Finds in database: { theme, content, ... }
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Page renders with theme colors & content
         â”‚     â”‚
         â”‚     â–¼
         â”‚  Browser receives complete HTML
         â”‚     â”‚
         â”‚     â–¼
         â”‚  User sees: cool-barber.com/about (URL unchanged!)
         â”‚            with Blue barber shop theme
         â”‚
         â””â”€ Done! âœ…
```

---

## Why This is Unbeatable

```
Metric              â”‚ Traditional      â”‚ Our Platform
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Cost per site       â”‚ $20-100/month    â”‚ $0.05-5/month
Scaling to 1000 sitesâ”‚ $20,000-100k/mo â”‚ $50-100/month
Time to add customer â”‚ 1-2 hours        â”‚ 30 seconds
Code redeployment   â”‚ YES (per site)   â”‚ NO (ever)
Database overhead   â”‚ Per customer     â”‚ Shared
Data ownership      â”‚ They own it      â”‚ YOU own it
SEO/Speed           â”‚ Good             â”‚ GREAT (SSR)
URL beauty          â”‚ Varies           â”‚ PERFECT
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

---

## The "Magic" Happens Here

The middleware is only **8 lines of code**, but it unlocks infinite scalability:

```typescript
export function middleware(request: NextRequest) {
  const hostname = request.headers.get('host');
  
  if (hostname?.includes('app.')) return NextResponse.next();
  
  const url = request.nextUrl.clone();
  url.pathname = `/site/${hostname}${request.nextUrl.pathname}`;
  
  return NextResponse.rewrite(url);  // â† THE MAGIC LINE
}
```

This single `NextResponse.rewrite()` enables:
- âœ… Serving 1,000,000 sites from 1 codebase
- âœ… Without any code deployment
- âœ… Without any infrastructure changes
- âœ… For a fraction of the cost

ğŸš€ **That's the whole secret!**
